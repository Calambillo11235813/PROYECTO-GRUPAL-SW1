<!DOCTYPE html>
<html>

<head>
    <title>An치lisis de Autenticidad de Voz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">An치lisis de Autenticidad de Voz</h1>

         
        <div class="card mb-4">
            <div class="card-header">
                <h5>Subir Archivo de Audio</h5>
            </div>
            <div class="card-body">
                <form id="audioUploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input type="file" class="form-control" id="audioFile" accept=".wav,.mp3" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Analizar Audio</button>
                </form>
            </div>
        </div>

         
        <div id="result" class="mt-4" style="display: none;">
            <h3>Resultado del An치lisis</h3>
            <div class="card">
                <div class="card-body">
                    <p><strong>Estado:</strong> <span id="resultStatus"></span></p>
                    <p><strong>Probabilidad:</strong> <span id="resultProbability"></span></p>
                    <audio id="audioPlayer" controls class="w-100 mt-3"></audio>

                    <div class="mt-3">
                        <h5>Espectrograma</h5>
                        <img id="resultSpectrogram" class="img-fluid" />
                    </div>
                </div>
            </div>
        </div>

         
        <div class="mt-4">
            <h3>Historial de An치lisis</h3>
            <div id="history" class="list-group"></div>
        </div>
    </div>

    <script>
        document.getElementById('audioUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('audioFile');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/audio/analyze/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });

                const result = await response.json();

                if (response.ok) {
                    displayResult(result.data);
                    loadHistory();
                } else {
                    alert('Error al analizar el audio: ' + (result.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            }
        });

        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            document.getElementById('resultStatus').textContent = data.result === 'real' ? 'Voz Real' : 'Posible Falsificaci칩n';
            document.getElementById('resultStatus').className = data.result === 'real' ? 'text-success' : 'text-danger';
            document.getElementById('resultProbability').textContent = (data.probability * 100).toFixed(2) + '%';

            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = data.file;

             
            if (data.spectrogram) {
                document.getElementById('resultSpectrogram').src = data.spectrogram;
            }

            resultDiv.style.display = 'block';
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/audio/analyze/');
                const data = await response.json();

                const historyDiv = document.getElementById('history');
                historyDiv.innerHTML = '';

                data.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'list-group-item';
                    itemElement.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${item.file.split('/').pop()}</h5>
                            <small class="text-${item.result === 'real' ? 'success' : 'danger'}">
                                ${item.result === 'real' ? 'Real' : 'Fake'} (${(item.probability * 100).toFixed(2)}%)
                            </small>
                        </div>
                        <small>${new Date(item.uploaded_at).toLocaleString()}</small>
                        <audio src="${item.file}" controls class="w-100 mt-2"></audio>

                        <!-- 游녢 Mostrar espectrograma -->
                        ${item.spectrogram ? `<img src="${item.spectrogram}" class="img-fluid mt-2"/>` : ""}
                    `;
                    historyDiv.appendChild(itemElement);
                });
            } catch (error) {
                console.error('Error al cargar el historial:', error);
            }
        }

         
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

         
        document.addEventListener('DOMContentLoaded', loadHistory);
    </script>
</body>

</html>
